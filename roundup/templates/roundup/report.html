{% load report_extras %}
<!DOCTYPE html>
<html lang="en">
<head>
  {% load static %}
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>{{ league_name }} ‚Äì Week {{ week }} Roundup</title>
  <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üèà</text></svg>">
  <link rel="stylesheet" href="{% static 'roundup/report.css' %}">
</head>
<body>
  <div class="grid">
    <header>
      <div>
        <h1>{{ league_name }} ‚Äì Week {{ week }} Roundup</h1>
      </div>
      <div class="nav">
        <a class="btn" href="{% url 'homepage' %}">üè† Home</a>
        {% if prev_disabled %}
          <span class="btn disabled">‚óÄ Previous</span>
        {% else %}
          <a class="btn" href="{% url 'weekly_report' year=year week=prev_week %}">‚óÄ Previous</a>
        {% endif %}
        {% if next_disabled %}
          <span class="btn disabled">Next ‚ñ∂</span>
        {% else %}
          <a class="btn" href="{% url 'weekly_report' year=year week=next_week %}">Next ‚ñ∂</a>
        {% endif %}
      </div>
    </header>

    <section class="card overview-card overview-section">
      <h2>Overview</h2>
      <p id="overview">
        <span class="spinner" id="overview-spinner"></span>
        <span class="loading">Loading AI overview‚Ä¶</span>
      </p>
    </section>

    <!-- Player Highlights and Weekly Incentive directly below Overview -->
    <div class="overview-row">
      <section class="card highlights-card">
        <h2>‚≠ê Player Highlights</h2>
          <ul class="awards">
            {% for a in awards %}
              <li class="award">
              <span class="award-icon">‚≠ê</span>
                <div class="award-body">
                  <div class="award-title">{{ a.title }}</div>
                  <div class="award-text">{{ a.text }}</div>
                </div>
              </li>
            {% empty %}
            <li class="muted">No highlights available.</li>
            {% endfor %}
          </ul>
      </section>
  
      <section class="card incentive-card">
        <h2>üèÜ Weekly Incentive</h2>
        <div class="incentive-content">
          <div class="incentive-section">
            <div class="incentive-label">This Week's Challenge</div>
            <div class="incentive-title">{{ weekly_incentive.this_title }}</div>
        </div>
          
          <div class="incentive-section">
            <div class="incentive-label">üèÖ Winner</div>
            <div class="incentive-winner">
              {% if weekly_incentive.winner_text %}
                <span class="winner-text">{{ weekly_incentive.winner_text }}</span>
              {% else %}
                <span class="pending-text">TBD - Check back after the games!</span>
              {% endif %}
            </div>
          </div>
          
          <div class="incentive-section">
            <div class="incentive-label">üéØ Next Week's Challenge</div>
            <div class="incentive-next">{{ weekly_incentive.next_title }}</div>
          </div>
        </div>
      </section>
    </div>

    <!-- Center: Weekly Scores (fills remaining height) -->
    <section class="card scores-card scores-section" id="scores-card">
      <h2>Weekly Scores</h2>
      
      <!-- Desktop Scores - Card Layout -->
      <div class="desktop-scores">
        {% for m in scoreboard %}
        <div class="score-matchup-card">
          <div class="score-team home-team {% if m.winner == m.home_team %}winner{% endif %}">
            <div class="team-info">
              <div class="team-name team-name-row">
                {% if m.home_id and m.home_logo %}
                  <img class="team-logo" src="{% url 'team_logo' team_id=m.home_id %}" alt="{{ m.home_team }} logo" />
                {% endif %}
                <span>{{ m.home_team }}</span>
              </div>
              {% if m.home_record %}<div class="team-record">{{ m.home_record }}</div>{% endif %}
            </div>
            <div class="team-score {% if m.winner == m.home_team %}winner-score{% endif %}">
              {{ m.home_score }}
            </div>
          </div>
          
          <div class="score-vs">
            <div class="vs-text">vs</div>
            {% if m.winner %}
              <div class="winner-indicator">üèÜ</div>
            {% endif %}
          </div>
          
          <div class="score-team away-team {% if m.winner == m.away_team %}winner{% endif %}">
            <div class="team-info">
              <div class="team-name team-name-row">
                {% if m.away_id and m.away_logo %}
                  <img class="team-logo" src="{% url 'team_logo' team_id=m.away_id %}" alt="{{ m.away_team }} logo" />
                {% endif %}
                <span>{{ m.away_team }}</span>
              </div>
              {% if m.away_record %}<div class="team-record">{{ m.away_record }}</div>{% endif %}
            </div>
            <div class="team-score {% if m.winner == m.away_team %}winner-score{% endif %}">
              {{ m.away_score }}
            </div>
          </div>
        </div>
        {% endfor %}
      </div>
      
      <!-- Legacy table for fallback -->
      <table class="scores hidden" id="scores-table">
        <tbody>
          {% for m in scoreboard %}
          <tr>
            <td class="name-col">
              <div class="team-cell-home">
                <span>{{ m.home_team }}{% if m.home_record %} <span class="muted">({{ m.home_record }})</span>{% endif %}</span>
              </div>
            </td>
            <td class="score-col">
              {% if m.winner == m.home_team %}
                <strong>{{ m.home_score }}</strong>
              {% else %}
                <span>{{ m.home_score }}</span>
              {% endif %}
            </td>
            <td class="vs-col">vs</td>
            <td class="score-col">
              {% if m.winner == m.away_team %}
                <strong>{{ m.away_score }}</strong>
              {% else %}
                <span>{{ m.away_score }}</span>
              {% endif %}
            </td>
            <td class="name-col">
              <div class="team-cell-away">
                <span>{{ m.away_team }}{% if m.away_record %}<span class="muted">({{ m.away_record }})</span>{% endif %}</span>
              </div>
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
      
      <!-- Mobile Scores Layout -->
      <div class="mobile-scores">
        {% for m in scoreboard %}
        <div class="mobile-score-card">
          <div class="mobile-score-teams">
            <div class="mobile-team">
              {% if m.home_id and m.home_logo %}
                <img class="mobile-team-logo" src="{% url 'team_logo' team_id=m.home_id %}" alt="{{ m.home_team }} logo" />
              {% endif %}
              <div class="mobile-team-name">{{ m.home_team }}</div>
              {% if m.home_record %}<div class="mobile-team-record">{{ m.home_record }}</div>{% endif %}
              <div class="mobile-score {% if m.winner != m.home_team %}loser{% endif %}">
                {% if m.winner == m.home_team %}<strong>{{ m.home_score }}</strong>{% else %}{{ m.home_score }}{% endif %}
              </div>
            </div>
            <div class="mobile-vs">vs</div>
            <div class="mobile-team">
              {% if m.away_id and m.away_logo %}
                <img class="mobile-team-logo" src="{% url 'team_logo' team_id=m.away_id %}" alt="{{ m.away_team }} logo" />
              {% endif %}
              <div class="mobile-team-name">{{ m.away_team }}</div>
              {% if m.away_record %}<div class="mobile-team-record">{{ m.away_record }}</div>{% endif %}
              <div class="mobile-score {% if m.winner != m.away_team %}loser{% endif %}">
                {% if m.winner == m.away_team %}<strong>{{ m.away_score }}</strong>{% else %}{{ m.away_score }}{% endif %}
              </div>
            </div>
          </div>
        </div>
        {% endfor %}
      </div>
    </section>

    <!-- Left: Booms/Busts only -->
    <aside class="card bb-card bb-aside">
      <h2>Booms &amp; Busts</h2>
      <div class="bb-grid">
        {% for row in incentives.boom_bust_by_position %}
        <div class="bb-position-card">
          <div class="bb-position-header">{{ row.position }}</div>
          
          <div class="bb-sections-container">
            <!-- Booms Section -->
            <div class="bb-section">
              <div class="bb-section-header boom">
                <span class="bb-section-title">Top 3 Booms</span>
              </div>
              <div class="bb-players-list">
                {% for player in row.booms %}
                <div class="bb-player-item boom">
                  <img class="bb-player-nfl-logo" src="{{ player.nfl_logo }}" alt="{{ player.nfl_team }} logo" />
                  <div class="bb-player-info">
                    <div class="bb-player-name">{{ player.player_name }}</div>
                    <div class="bb-player-team">{{ player.fantasy_team }}</div>
                  </div>
                  <div class="bb-player-points">{{ player.points }} pts</div>
                </div>
                {% empty %}
                <div class="bb-player-item boom no-data">
                  <div class="bb-player-info">
                    <div class="bb-player-name muted">No data</div>
                  </div>
                </div>
                {% endfor %}
              </div>
            </div>
            
            <!-- Busts Section -->
            <div class="bb-section">
              <div class="bb-section-header bust">
                <span class="bb-section-title">Top 3 Busts</span>
              </div>
              <div class="bb-players-list">
                {% for player in row.busts %}
                <div class="bb-player-item bust">
                  <img class="bb-player-nfl-logo" src="{{ player.nfl_logo }}" alt="{{ player.nfl_team }} logo" />
                  <div class="bb-player-info">
                    <div class="bb-player-name">{{ player.player_name }}</div>
                    <div class="bb-player-team">{{ player.fantasy_team }}</div>
                  </div>
                  <div class="bb-player-points">{{ player.points }} pts</div>
                </div>
                {% empty %}
                <div class="bb-player-item bust no-data">
                  <div class="bb-player-info">
                    <div class="bb-player-name muted">No data</div>
                  </div>
                </div>
                {% endfor %}
              </div>
            </div>
          </div>
        </div>
        {% empty %}
        <div class="bb-no-data">
          <span class="muted">No player data available.</span>
        </div>
        {% endfor %}
      </div>
      
      <!-- Mobile Booms/Busts Layout -->
      <div class="mobile-bb">
        {% for row in incentives.boom_bust_by_position %}
        <div class="mobile-bb-position">
          <div class="mobile-bb-position-title">{{ row.position }}</div>
          <div class="mobile-bb-sections-container">
            <!-- Mobile Booms -->
            <div class="mobile-bb-section">
              <div class="mobile-bb-section-title">Top 3 Booms</div>
              <div class="mobile-bb-players-list">
                {% for player in row.booms %}
                <div class="mobile-bb-player-item boom">
                  <img class="mobile-bb-player-nfl-logo" src="{{ player.nfl_logo }}" alt="{{ player.nfl_team }} logo" />
                  <div class="mobile-bb-player-info">
                    <div class="mobile-bb-player-name">{{ player.player_name }}</div>
                    <div class="mobile-bb-player-team">{{ player.fantasy_team }}</div>
                  </div>
                  <div class="mobile-bb-player-points">{{ player.points }} pts</div>
                </div>
                {% empty %}
                <div class="mobile-bb-player-item boom no-data">
                  <div class="mobile-bb-player-info">
                    <div class="mobile-bb-player-name muted">No data</div>
                  </div>
                </div>
                {% endfor %}
              </div>
            </div>
            
            <!-- Mobile Busts -->
            <div class="mobile-bb-section">
              <div class="mobile-bb-section-title">Top 3 Busts</div>
              <div class="mobile-bb-players-list">
                {% for player in row.busts %}
                <div class="mobile-bb-player-item bust">
                  <img class="mobile-bb-player-nfl-logo" src="{{ player.nfl_logo }}" alt="{{ player.nfl_team }} logo" />
                  <div class="mobile-bb-player-info">
                    <div class="mobile-bb-player-name">{{ player.player_name }}</div>
                    <div class="mobile-bb-player-team">{{ player.fantasy_team }}</div>
                  </div>
                  <div class="mobile-bb-player-points">{{ player.points }} pts</div>
                </div>
                {% empty %}
                <div class="mobile-bb-player-item bust no-data">
                  <div class="mobile-bb-player-info">
                    <div class="mobile-bb-player-name muted">No data</div>
                  </div>
                </div>
                {% endfor %}
              </div>
            </div>
          </div>
        </div>
        {% endfor %}
      </div>
    </aside>

    <!-- Right: Standings only -->
    <aside class="card standings-card standings-aside">
      <h2>Standings</h2>
      
      <!-- Desktop Standings - Card Layout -->
      <div class="desktop-standings">
        {% for t in standings %}
        <div class="standing-team-card {% if t.rank <= playoff_team_count %}playoff{% endif %} {% if t.rank == playoff_team_count %}cutoff{% endif %}">
          <div class="standing-rank">
            <div class="rank-number">#{{ t.rank }}</div>
            {% if t.rank <= playoff_team_count %}
              <div class="playoff-badge">üèÜ</div>
            {% endif %}
          </div>
          
          <div class="standing-team-info">
            <div class="team-name">{{ t.team_name }}</div>
            {% if t.movement_abs %}
              <div class="movement-indicator {% if t.movement_is_up %}up{% else %}down{% endif %}">
                {% if t.movement_is_up %}‚ñ≤{% else %}‚ñº{% endif %} {{ t.movement_abs }}
              </div>
            {% endif %}
          </div>
          
          <div class="standing-stats">
            <div class="record-badge">{{ t.wins }}-{{ t.losses }}-{{ t.ties }}</div>
            <div class="points-display">{{ t.points_for }}</div>
          </div>
        </div>
        {% endfor %}
      </div>
      
      <!-- Legacy table for fallback -->
      <table class="standings hidden">
        <thead>
          <tr><th>Team</th><th>W-L-T</th><th>PF</th></tr>
        </thead>
        <tbody>
          {% for t in standings %}
          <tr class="{% if t.rank <= playoff_team_count %}playoff {% endif %}{% if t.rank == playoff_team_count %}cutoff{% endif %}">
            <td>
              <span>{{ t.team_name }}</span>
              {% if t.movement_abs %}
                {% if t.movement_is_up %}
                  <span class="move up">‚ñ≤ {{ t.movement_abs }}</span>
                {% else %}
                  <span class="move down">‚ñº {{ t.movement_abs }}</span>
                {% endif %}
                  {% endif %}
                </td>
            <td>{{ t.wins }}-{{ t.losses }}-{{ t.ties }}</td>
            <td>{{ t.points_for }}</td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      
      <!-- Mobile Standings Layout -->
      <div class="mobile-standings">
        {% for t in standings %}
        <div class="mobile-standing-item {% if t.rank <= playoff_team_count %}playoff{% endif %} {% if t.rank == playoff_team_count %}cutoff{% endif %}">
          <div class="mobile-standing-rank">#{{ t.rank }}</div>
          <div class="mobile-standing-team">
            {{ t.team_name }}
            {% if t.movement_abs %}
              {% if t.movement_is_up %}
                <span class="move up">‚ñ≤ {{ t.movement_abs }}</span>
              {% else %}
                <span class="move down">‚ñº {{ t.movement_abs }}</span>
              {% endif %}
            {% endif %}
          </div>
          <div class="mobile-standing-stats">
            <div class="mobile-standing-record">{{ t.wins }}-{{ t.losses }}-{{ t.ties }}</div>
            <div class="mobile-standing-pf">{{ t.points_for }}</div>
          </div>
        </div>
        {% endfor %}
      </div>
      <div class="muted-with-margin">Top {{ playoff_team_count }} highlighted as current playoff positions.</div>
    </aside>
    
    <!-- Mobile Booms & Busts - Moved to bottom for mobile layout -->
    <div class="mobile-bb-bottom">
      <div class="card bb-card">
        <h2>Booms &amp; Busts</h2>
        <div class="mobile-bb">
          {% for row in incentives.boom_bust_by_position %}
          <div class="mobile-bb-position">
            <div class="mobile-bb-position-title">{{ row.position }}</div>
            <div class="mobile-bb-sections-container">
              <!-- Mobile Booms -->
              <div class="mobile-bb-section">
                <div class="mobile-bb-section-title">Top 3 Booms</div>
                <div class="mobile-bb-players-list">
                  {% for player in row.booms %}
                  <div class="mobile-bb-player-item boom">
                    <img class="mobile-bb-player-nfl-logo" src="{{ player.nfl_logo }}" alt="{{ player.nfl_team }} logo" />
                    <div class="mobile-bb-player-info">
                      <div class="mobile-bb-player-name">{{ player.player_name }}</div>
                      <div class="mobile-bb-player-team">{{ player.fantasy_team }}</div>
                    </div>
                    <div class="mobile-bb-player-points">{{ player.points }} pts</div>
                  </div>
                  {% empty %}
                  <div class="mobile-bb-player-item boom no-data">
                    <div class="mobile-bb-player-info">
                      <div class="mobile-bb-player-name muted">No data</div>
                    </div>
                  </div>
                  {% endfor %}
                </div>
              </div>
              
              <!-- Mobile Busts -->
              <div class="mobile-bb-section">
                <div class="mobile-bb-section-title">Top 3 Busts</div>
                <div class="mobile-bb-players-list">
                  {% for player in row.busts %}
                  <div class="mobile-bb-player-item bust">
                    <img class="mobile-bb-player-nfl-logo" src="{{ player.nfl_logo }}" alt="{{ player.nfl_team }} logo" />
                    <div class="mobile-bb-player-info">
                      <div class="mobile-bb-player-name">{{ player.player_name }}</div>
                      <div class="mobile-bb-player-team">{{ player.fantasy_team }}</div>
                    </div>
                    <div class="mobile-bb-player-points">{{ player.points }} pts</div>
                  </div>
                  {% empty %}
                  <div class="mobile-bb-player-item bust no-data">
                    <div class="mobile-bb-player-info">
                      <div class="mobile-bb-player-name muted">No data</div>
                    </div>
                  </div>
                  {% endfor %}
                </div>
              </div>
            </div>
          </div>
          {% endfor %}
        </div>
      </div>
    </div>
  </div>
  <script>
    (function() {
      const overviewEndpoint = "{% url 'weekly_report_overview_api' year=year week=week %}";
      function setText(id, text) {
        const el = document.getElementById(id);
        if (el) { el.textContent = text || ''; }
      }
      function hideSpinner(id) {
        const spinner = document.getElementById(id);
        if (spinner) { spinner.classList.add('hidden'); }
      }
      function showError(id, spinnerId, msg) {
        hideSpinner(spinnerId);
        const el = document.getElementById(id);
        if (el) { el.innerHTML = `<span class="loading">${msg}</span>`; }
      }
      // Fetch smaller chunks in parallel
      function poll(endpoint, onOk, onError) {
        fetch(endpoint)
          .then(r => {
            if (r.status === 202) throw new Error('pending');
            if (!r.ok) throw new Error('error');
            return r.json();
          })
          .then(onOk)
          .catch(() => {
            onError();
            setTimeout(() => poll(endpoint, onOk, onError), 4000);
          });
      }

      poll(overviewEndpoint, (d) => {
        setText('overview', d.overview || '');
        hideSpinner('overview-spinner');
      }, () => {
        showError('overview', 'overview-spinner', 'Overview is taking longer than usual‚Ä¶');
      });

      function sizeWeeklyScores() {
        const card = document.getElementById('scores-card');
        const table = document.getElementById('scores-table');
        if (!card || !table) return;
        // Compute available height beneath the header inside the card
        const cardRect = card.getBoundingClientRect();
        const tableRect = table.getBoundingClientRect();
        const available = Math.max(0, cardRect.height - (tableRect.top - cardRect.top) - 8);
        table.style.height = available + 'px';

        const rows = table.querySelectorAll('tbody > tr');
        if (rows.length > 0) {
          const per = Math.max(48, Math.floor(available / rows.length));
          rows.forEach(r => { r.style.height = per + 'px'; });
        }
      }
      window.addEventListener('resize', sizeWeeklyScores);
      // Defer to next frame so layout is stable
      requestAnimationFrame(sizeWeeklyScores);

      // Simple tabs in left aside
      const tabButtons = document.querySelectorAll('.tab-btn');
      tabButtons.forEach(btn => {
        btn.addEventListener('click', () => {
          const tab = btn.getAttribute('data-tab');
          document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
          btn.classList.add('active');
          document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
          const target = document.getElementById(`tab-${tab}`);
          if (target) target.classList.add('active');
        });
      });
    })();
  </script>
</body>
</html>
