{% load report_extras %}
<!DOCTYPE html>
<html lang="en">
<head>
  {% load static %}
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>{{ league_name }} ‚Äì Week {{ week }} Roundup</title>
  <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üèà</text></svg>">
  <link rel="stylesheet" href="{% static 'roundup/report.css' %}">
</head>
<body>
  <div class="grid">
    <header>
      <div>
        <h1>{{ league_name }} ‚Äì Week {{ week }} Roundup</h1>
      </div>
      <div class="nav">
        <a class="btn" href="{% url 'homepage' %}">üè† Home</a>
        {% if prev_disabled %}
          <span class="btn disabled">‚óÄ Previous</span>
        {% else %}
          <a class="btn" href="{% url 'weekly_report' year=year week=prev_week %}">‚óÄ Previous</a>
        {% endif %}
        {% if next_disabled %}
          <span class="btn disabled">Next ‚ñ∂</span>
        {% else %}
          <a class="btn" href="{% url 'weekly_report' year=year week=next_week %}">Next ‚ñ∂</a>
        {% endif %}
      </div>
    </header>

    <section class="card overview-card overview-section">
      <h2>Overview</h2>
      <p id="overview">
        <span class="spinner" id="overview-spinner"></span>
        <span class="loading">Loading AI overview‚Ä¶</span>
      </p>
    </section>

    <!-- Left: Standings (stretches from below overview to bottom) -->
    <aside class="card standings-card standings-aside">
      <h2>Standings</h2>
      
      <!-- Desktop Standings - Card Layout -->
      <div class="desktop-standings">
        {% for t in standings %}
        <div class="standing-team-card {% if t.rank <= playoff_team_count %}playoff{% endif %} {% if t.rank == playoff_team_count %}cutoff{% endif %}">
          <div class="standing-rank">
            <div class="rank-number">#{{ t.rank }}</div>
            {% if t.rank <= playoff_team_count %}
              <div class="playoff-badge">üèÜ</div>
            {% endif %}
          </div>
          
          <div class="standing-team-info">
            <div class="team-name">{{ t.team_name }}</div>
            {% if t.owner_name %}<div class="team-owner">{{ t.owner_name }}</div>{% endif %}
            {% if t.movement_abs %}
              <div class="movement-indicator {% if t.movement_is_up %}up{% else %}down{% endif %}">
                {% if t.movement_is_up %}‚ñ≤{% else %}‚ñº{% endif %} {{ t.movement_abs }}
              </div>
            {% endif %}
          </div>
          
          <div class="standing-stats">
            <div class="record-badge">{{ t.wins }}-{{ t.losses }}-{{ t.ties }}</div>
            <div class="points-display">{{ t.points_for }}</div>
          </div>
        </div>
        {% endfor %}
      </div>
      
      <div class="muted-with-margin">Top {{ playoff_team_count }} highlighted as current playoff positions.</div>
    </aside>



    <!-- Right: Player Highlights and Weekly Incentive (top row) -->
    <div class="overview-row">
      <section class="card highlights-card">
        <h2>‚≠ê Player Highlights</h2>
        <ul class="awards">
          {% for a in awards %}
            <li class="award">
              <span class="award-icon">‚≠ê</span>
              <div class="award-body">
                <div class="award-title">{{ a.title }}</div>
                <div class="award-text">{{ a.text }}</div>
              </div>
            </li>
          {% empty %}
            <li class="muted">No highlights available.</li>
          {% endfor %}
        </ul>
      </section>
  
      <section class="card incentive-card">
        <h2>üèÜ Weekly Incentive</h2>
        <div class="incentive-content">
          <div class="incentive-section">
            <div class="incentive-label">This Week's Challenge</div>
            <div class="incentive-title">{{ weekly_incentive.this_title }}</div>
          </div>
          
          <div class="incentive-section">
            <div class="incentive-label">üèÖ Winner</div>
            <div class="incentive-winner">
              {% if weekly_incentive.winner_text %}
                <span class="winner-text">{{ weekly_incentive.winner_text }}</span>
              {% else %}
                <span class="pending-text">TBD - Check back after the games!</span>
              {% endif %}
            </div>
          </div>
          
          <div class="incentive-section">
            <div class="incentive-label">üéØ Next Week's Challenge</div>
            <div class="incentive-next">{{ weekly_incentive.next_title }}</div>
          </div>
        </div>
      </section>
    </div>

    <!-- Right: Weekly Scores (middle row) -->
    <section class="card scores-card scores-section" id="scores-card">
      <h2>Weekly Scores</h2>
      
      <!-- Desktop Scores - Card Layout (Horizontal Flow) -->
      <div class="desktop-scores">
        {% for m in scoreboard %}
        <div class="score-matchup-card">
          <!-- Home Team Logo + Info -->
          <div class="score-team-left">
            {% if m.home_id and m.home_logo %}
              <img class="score-team-logo" src="{% url 'team_logo' team_id=m.home_id %}" alt="{{ m.home_team }} logo" />
            {% endif %}
            <div class="score-team-details">
              <div class="team-name">{{ m.home_team }}</div>
              {% if m.home_owner %}<div class="team-owner">{{ m.home_owner }}</div>{% endif %}
              <div class="team-record">{{ m.home_wins }}-{{ m.home_losses }}-{{ m.home_ties }}</div>
            </div>
          </div>
          
          <!-- Scores and VS Container (Centered) -->
          <div class="score-scores-container">
            <!-- Home Team Score -->
            <div class="score-home">{{ m.home_score }}</div>
            
            <!-- VS Separator -->
            <div class="score-vs">vs</div>
            
            <!-- Away Team Score -->
            <div class="score-away">{{ m.away_score }}</div>
          </div>
          
          <!-- Away Team Logo + Info -->
          <div class="score-team-right">
            <div class="score-team-details">
              <div class="team-name">{{ m.away_team }}</div>
              {% if m.away_owner %}<div class="team-owner">{{ m.away_owner }}</div>{% endif %}
              <div class="team-record">{{ m.away_wins }}-{{ m.away_losses }}-{{ m.away_ties }}</div>
            </div>
            {% if m.away_id and m.away_logo %}
              <img class="score-team-logo" src="{% url 'team_logo' team_id=m.away_id %}" alt="{{ m.away_team }} logo" />
            {% endif %}
          </div>
        </div>
        {% endfor %}
      </div>
      
      <!-- Mobile Scores - Simplified Layout -->
      <div class="mobile-scores">
        {% for m in scoreboard %}
        <div class="mobile-score-card">
          <!-- Home Team -->
          <div class="mobile-score-team">
            {% if m.home_id and m.home_logo %}
              <img class="mobile-score-team-logo" src="{% url 'team_logo' team_id=m.home_id %}" alt="{{ m.home_team }} logo" />
            {% endif %}
            <div class="mobile-score-team-details">
              <div class="mobile-team-name">{{ m.home_team }}</div>
              {% if m.home_owner %}<div class="mobile-team-owner">{{ m.home_owner }}</div>{% endif %}
              <div class="mobile-team-record">{{ m.home_wins }}-{{ m.home_losses }}-{{ m.home_ties }}</div>
            </div>
            <div class="mobile-score-home">{{ m.home_score }}</div>
          </div>
          
          <!-- VS -->
          <div class="mobile-score-vs">vs</div>
          
          <!-- Away Team -->
          <div class="mobile-score-team">
            {% if m.away_id and m.away_logo %}
              <img class="mobile-score-team-logo" src="{% url 'team_logo' team_id=m.away_id %}" alt="{{ m.away_team }} logo" />
            {% endif %}
            <div class="mobile-score-team-details">
              <div class="mobile-team-name">{{ m.away_team }}</div>
              {% if m.away_owner %}<div class="mobile-team-owner">{{ m.away_owner }}</div>{% endif %}
              <div class="mobile-team-record">{{ m.away_wins }}-{{ m.away_losses }}-{{ m.away_ties }}</div>
            </div>
            <div class="mobile-score-away">{{ m.away_score }}</div>
          </div>
        </div>
        {% endfor %}
      </div>
    </section>

    <!-- Mobile Standings Layout - Positioned below weekly scores -->
    <div class="mobile-standings">
      {% for t in standings %}
      <div class="mobile-standing-item {% if t.rank <= playoff_team_count %}playoff{% endif %} {% if t.rank == playoff_team_count %}cutoff{% endif %}">
        <div class="mobile-standing-rank">#{{ t.rank }}</div>
        <div class="mobile-standing-team">
          <div class="mobile-team-name">{{ t.team_name }}</div>
          {% if t.owner_name %}<div class="mobile-team-owner">{{ t.owner_name }}</div>{% endif %}
          {% if t.movement_abs %}
            {% if t.movement_is_up %}
              <span class="move up">‚ñ≤ {{ t.movement_abs }}</span>
            {% else %}
              <span class="move down">‚ñº {{ t.movement_abs }}</span>
            {% endif %}
          {% endif %}
        </div>
        <div class="mobile-standing-stats">
          <div class="mobile-standing-record">{{ t.wins }}-{{ t.losses }}-{{ t.ties }}</div>
          <div class="mobile-standing-pf">{{ t.points_for }}</div>
        </div>
      </div>
      {% endfor %}
    </div>

    <!-- Right: Booms & Busts (bottom row) -->
    <section class="card bb-card bb-section-below">
      <h2>Booms &amp; Busts</h2>
      <div class="bb-positions-grid">
        {% for row in incentives.boom_bust_by_position %}
        <div class="bb-position-card">
          <div class="bb-position-header">{{ row.position }}</div>
          
          <div class="bb-sections-container">
            <!-- Booms Section -->
            <div class="bb-section">
              <div class="bb-section-header boom">
                <span class="bb-section-title">Top 3 Booms</span>
              </div>
              <div class="bb-players-list">
                {% for player in row.booms %}
                <div class="bb-player-item boom">
                  <img class="bb-player-nfl-logo" src="{{ player.nfl_logo }}" alt="{{ player.nfl_team }} logo" />
                  <div class="bb-player-info">
                    <div class="bb-player-name">{{ player.player_name }}</div>
                    <div class="bb-player-team">{{ player.fantasy_team }}</div>
                  </div>
                  <div class="bb-player-points">{{ player.points }} pts</div>
                </div>
                {% empty %}
                <div class="bb-player-item boom no-data">
                  <div class="bb-player-info">
                    <div class="bb-player-name muted">No data</div>
                  </div>
                </div>
                {% endfor %}
              </div>
            </div>
            
            <!-- Busts Section -->
            <div class="bb-section">
              <div class="bb-section-header bust">
                <span class="bb-section-title">Top 3 Busts</span>
              </div>
              <div class="bb-players-list">
                {% for player in row.busts %}
                <div class="bb-player-item bust">
                  <img class="bb-player-nfl-logo" src="{{ player.nfl_logo }}" alt="{{ player.nfl_team }} logo" />
                  <div class="bb-player-info">
                    <div class="bb-player-name">{{ player.player_name }}</div>
                    <div class="bb-player-team">{{ player.fantasy_team }}</div>
                  </div>
                  <div class="bb-player-points">{{ player.points }} pts</div>
                </div>
                {% empty %}
                <div class="bb-player-item bust no-data">
                  <div class="bb-player-info">
                    <div class="bb-player-name muted">No data</div>
                  </div>
                </div>
                {% endfor %}
              </div>
            </div>
          </div>
        </div>
        {% empty %}
        <div class="bb-no-data">
          <span class="muted">No player data available.</span>
        </div>
        {% endfor %}
      </div>
      

    </section>
  </div>

  <!-- Mobile Booms/Busts Layout - Positioned at bottom of page -->
  <div class="mobile-bb-bottom">
    {% for row in incentives.boom_bust_by_position %}
    <div class="mobile-bb-position">
      <div class="mobile-bb-position-title">{{ row.position }}</div>
      <div class="mobile-bb-sections-container">
        <!-- Mobile Booms -->
        <div class="mobile-bb-section">
          <div class="mobile-bb-section-title">Top 3 Booms</div>
          <div class="mobile-bb-players-list">
            {% for player in row.booms %}
            <div class="mobile-bb-player-item boom">
              <img class="mobile-bb-player-nfl-logo" src="{{ player.nfl_logo }}" alt="{{ player.nfl_team }} logo" />
              <div class="mobile-bb-player-info">
                <div class="mobile-bb-player-name">{{ player.player_name }}</div>
                <div class="mobile-bb-player-team">{{ player.fantasy_team }}</div>
              </div>
              <div class="mobile-bb-player-points">{{ player.points }} pts</div>
            </div>
            {% empty %}
            <div class="mobile-bb-player-item boom no-data">
              <div class="bb-player-info">
                <div class="bb-player-name muted">No data</div>
              </div>
            </div>
            {% endfor %}
          </div>
        </div>
        
        <!-- Mobile Busts -->
        <div class="mobile-bb-section">
          <div class="mobile-bb-section-title">Top 3 Busts</div>
          <div class="mobile-bb-players-list">
            {% for player in row.busts %}
            <div class="mobile-bb-player-item bust">
              <img class="mobile-bb-player-nfl-logo" src="{{ player.nfl_logo }}" alt="{{ player.nfl_team }} logo" />
              <div class="mobile-bb-player-info">
                <div class="mobile-bb-player-name">{{ player.player_name }}</div>
                <div class="mobile-bb-player-team">{{ player.fantasy_team }}</div>
              </div>
              <div class="mobile-bb-player-points">{{ player.points }} pts</div>
            </div>
            {% empty %}
            <div class="mobile-bb-player-item bust no-data">
              <div class="bb-player-info">
                <div class="bb-player-name muted">No data</div>
              </div>
            </div>
            {% endfor %}
          </div>
        </div>
      </div>
    </div>
    {% endfor %}
  </div>

  <script>
    (function() {
      // Overview loading and error handling
      const overviewElement = document.getElementById('overview');
      const overviewSpinner = document.getElementById('overview-spinner');
      
      // Function to load overview content
      async function loadOverview() {
        try {
          const response = await fetch(`{% url 'weekly_report_overview_api' year=year week=week %}`);
          if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
          }
          const data = await response.json();
          
          if (data.overview) {
            overviewElement.innerHTML = data.overview;
          } else {
            overviewElement.innerHTML = '<span class="error">No overview available.</span>';
          }
        } catch (error) {
          console.error('Error loading overview:', error);
          overviewElement.innerHTML = '<span class="error">Failed to load overview. Please try again later.</span>';
        } finally {
          if (overviewSpinner) {
            overviewSpinner.style.display = 'none';
          }
        }
      }
      
      // Load overview when page loads
      loadOverview();
    })();
  </script>
</body>
</html>
