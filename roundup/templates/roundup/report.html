{% load report_extras %}
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>{{ league_name }} – Week {{ week }} Roundup</title>
  <style>
    :root {
      --primary: #3b82f6;
      --primary-dark: #2563eb;
      --primary-light: #dbeafe;
      --secondary: #8b5cf6;
      --accent: #06b6d4;
      --success: #10b981;
      --warning: #f59e0b;
      --danger: #ef4444;
      --gray-50: #f9fafb;
      --gray-100: #f3f4f6;
      --gray-200: #e5e7eb;
      --gray-300: #d1d5db;
      --gray-400: #9ca3af;
      --gray-500: #6b7280;
      --gray-600: #4b5563;
      --gray-700: #374151;
      --gray-800: #1f2937;
      --gray-900: #111827;
      --shadow-sm: 0 1px 2px 0 rgb(0 0 0 / 0.05);
      --shadow: 0 1px 3px 0 rgb(0 0 0 / 0.1), 0 1px 2px -1px rgb(0 0 0 / 0.1);
      --shadow-md: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
      --shadow-lg: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);
      --shadow-xl: 0 20px 25px -5px rgb(0 0 0 / 0.1), 0 8px 10px -6px rgb(0 0 0 / 0.1);
    }

    * {
      box-sizing: border-box;
    }

    body { 
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif; 
      margin: 0; 
      padding: 20px; 
      color: var(--gray-800); 
      background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
      min-height: 100vh;
      line-height: 1.6;
    }

    .grid { 
      display: grid; 
      grid-template-columns: 1fr 2.3fr 1.2fr; 
      grid-template-rows: auto auto 1fr; 
      gap: 24px; 
      min-height: calc(100vh - 40px);
      max-width: 1400px;
      margin: 0 auto;
    }

    header { 
      grid-column: 1 / -1; 
      display: flex; 
      align-items: center; 
      justify-content: space-between; 
      gap: 16px; 
      flex-wrap: wrap;
      background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
      color: white;
      padding: 24px 32px;
      border-radius: 16px;
      box-shadow: var(--shadow-xl);
      margin-bottom: 8px;
    }

    .card { 
      background: white; 
      border: 1px solid var(--gray-200); 
      border-radius: 16px; 
      padding: 24px; 
      box-shadow: var(--shadow-lg);
      transition: all 0.2s ease;
      border: none;
    }

    .card:hover {
      transform: translateY(-2px);
      box-shadow: var(--shadow-xl);
    }

    .banner { 
      background: linear-gradient(135deg, var(--primary), var(--secondary)); 
      color: white; 
      border: none; 
      box-shadow: var(--shadow-xl);
    }

    h1 { 
      margin: 0; 
      font-size: 28px; 
      font-weight: 800; 
      letter-spacing: -0.025em;
      text-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }

    h2 { 
      margin: 0 0 16px; 
      font-size: 20px; 
      font-weight: 700; 
      color: var(--gray-800);
      letter-spacing: -0.025em;
    }

    ul { 
      margin: 12px 0; 
      padding-left: 20px; 
    }

    table { 
      width: 100%; 
      border-collapse: collapse; 
    }

    .scores { 
      width: 100%; 
      table-layout: fixed; 
      font-variant-numeric: tabular-nums; 
    }

    th, td { 
      padding: 16px 12px; 
      border-bottom: 1px solid var(--gray-200); 
      vertical-align: middle; 
    }

    th { 
      text-align: left; 
      color: var(--gray-600); 
      font-weight: 600; 
      font-size: 12px; 
      text-transform: uppercase; 
      letter-spacing: .05em;
      background: var(--gray-50);
      border-bottom: 2px solid var(--gray-200);
    }

    tbody tr:nth-child(odd) { 
      background: var(--gray-50); 
    }

    tbody tr:nth-child(even) {
      background: white;
    }

    tbody tr:hover {
      background: var(--primary-light);
      transform: scale(1.01);
      transition: all 0.2s ease;
    }

    tbody tr.close { 
      background: #fef3c7; 
      border-left: 4px solid var(--warning);
    }

    .standings { 
      table-layout: fixed; 
    }

    .standings tr.playoff { 
      background: #ecfdf5; 
      border-left: 4px solid var(--success);
    }

    .standings tr.cutoff > td { 
      border-bottom: 3px solid var(--success); 
      font-weight: 600;
    }

    .standings th, .standings td { 
      white-space: nowrap; 
    }

    .standings th:nth-child(2), .standings td:nth-child(2) { 
      width: 88px; 
      text-align: center; 
    }

    .standings th:nth-child(3), .standings td:nth-child(3) { 
      width: 84px; 
      text-align: right; 
    }

    .standings td:nth-child(2), .standings td:nth-child(3) { 
      font-size: 14px; 
      line-height: 1.25; 
    }

    .standings td:first-child { 
      white-space: normal; 
      overflow: visible; 
      text-overflow: initial; 
      font-size: 14px; 
      line-height: 1.25; 
    }

    .muted { 
      color: var(--gray-500); 
      font-size: 13px; 
    }

    .two-col { 
      display: grid; 
      grid-template-columns: 1fr 1fr; 
      gap: 16px; 
    }

    .team-cell-home { 
      display: flex; 
      align-items: center; 
      gap: 8px; 
      justify-content: flex-end; 
    }

    .team-cell-away { 
      display: flex; 
      align-items: center; 
      gap: 8px; 
      justify-content: flex-start; 
    }

    .team-cell img { 
      width: 24px; 
      height: 24px; 
      border-radius: 8px; 
      object-fit: cover; 
      background: white; 
      border: 2px solid var(--gray-200); 
      box-shadow: var(--shadow-sm);
    }

    .score-col { 
      width: 120px; 
      text-align: center; 
      font-size: 32px; 
      font-weight: 700;
    }

    .score-col strong { 
      color: var(--success); 
      text-shadow: 0 2px 4px rgba(16,185,129,0.2);
    }

    .vs-col { 
      width: 40px; 
      text-align: center; 
      color: var(--gray-500); 
      font-weight: 600; 
      font-size: 14px;
    }

    .logo-col { 
      width: 28px; 
      text-align: center; 
    }

    .logo-img { 
      width: 24px; 
      height: 24px; 
      border-radius: 8px; 
      object-fit: cover; 
      background: white; 
      border: 2px solid var(--gray-200); 
      box-shadow: var(--shadow-sm);
    }

    .name-col { 
      width: auto; 
      font-weight: 600; 
    }

    .pill { 
      display: inline-block; 
      padding: 4px 12px; 
      border-radius: 999px; 
      background: var(--primary-light); 
      color: var(--primary-dark); 
      font-size: 12px; 
      font-weight: 600; 
      box-shadow: var(--shadow-sm);
    }

    .move { 
      font-size: 12px; 
      margin-left: 8px; 
      padding: 2px 6px;
      border-radius: 6px;
      font-weight: 600;
    }

    .move.up { 
      color: var(--success); 
      background: #ecfdf5;
    }

    .move.down { 
      color: var(--danger); 
      background: #fef2f2;
    }

    .nav { 
      display: flex; 
      align-items: center; 
      gap: 12px; 
    }

    .btn { 
      display: inline-flex; 
      align-items: center; 
      gap: 8px; 
      padding: 10px 16px; 
      border: 2px solid rgba(255,255,255,0.3); 
      border-radius: 12px; 
      background: rgba(255,255,255,0.1); 
      color: white; 
      text-decoration: none; 
      font-size: 14px; 
      font-weight: 600;
      transition: all 0.2s ease;
      backdrop-filter: blur(10px);
    }

    .btn:hover { 
      background: rgba(255,255,255,0.2); 
      border-color: rgba(255,255,255,0.5);
      transform: translateY(-1px);
    }

    .btn.disabled { 
      pointer-events: none; 
      opacity: 0.5; 
    }

    .loading { 
      color: var(--gray-600); 
      font-style: italic; 
    }

    .hidden { 
      display: none; 
    }

    .spinner { 
      width: 20px; 
      height: 20px; 
      border: 3px solid var(--gray-300); 
      border-top-color: var(--primary); 
      border-radius: 50%; 
      display: inline-block; 
      animation: spin 1s linear infinite; 
      vertical-align: text-bottom; 
      margin-right: 8px; 
    }

    @keyframes spin { 
      from { transform: rotate(0deg);} 
      to { transform: rotate(360deg);} 
    }

    .table-sticky thead th { 
      position: sticky; 
      top: 0; 
      background: var(--gray-50); 
      z-index: 1; 
    }

    .pts-col { 
      width: 64px; 
      text-align: center; 
      font-variant-numeric: tabular-nums; 
      font-size: 20px; 
    }

    .bb-table { 
      width: 100%; 
      border-collapse: collapse; 
    }

    .bb-table th + th, .bb-table td + td { 
      border-left: 1px solid var(--gray-200); 
    }

    .bb-table .logo-col { 
      width: 36px; 
      text-align: center; 
    }

    .bb-table .pts-col { 
      width: 80px; 
      font-size: 22px; 
    }

    .bb-logo { 
      width: 28px; 
      height: 28px; 
      border-radius: 8px;
      border: 2px solid var(--gray-200);
      box-shadow: var(--shadow-sm);
    }

    .bb-name-text strong { 
      font-size: 14px; 
      font-weight: 700; 
    }

    .bb-sub { 
      font-size: 12px !important; 
    }

    .section-divider { 
      border-top: 2px solid var(--gray-200); 
      margin: 16px 0 20px; 
    }

    .awards { 
      list-style: none; 
      padding: 0; 
      margin: 0; 
      display: grid; 
      grid-template-columns: 1fr; 
      gap: 12px; 
    }

    .award { 
      display: flex; 
      align-items: flex-start; 
      gap: 12px; 
      border: 1px solid var(--gray-200); 
      background: var(--gray-50); 
      border-radius: 12px; 
      padding: 16px; 
      transition: all 0.2s ease;
    }

    .award:hover {
      background: white;
      box-shadow: var(--shadow-md);
      transform: translateY(-1px);
    }

    .award-icon { 
      width: 32px; 
      height: 32px; 
      border-radius: 50%; 
      display: inline-flex; 
      align-items: center; 
      justify-content: center; 
      font-size: 16px; 
      background: linear-gradient(135deg, var(--primary), var(--secondary)); 
      color: white; 
      font-weight: 700; 
      flex-shrink: 0; 
      box-shadow: var(--shadow);
    }

    .award-body { 
      display: grid; 
      gap: 4px; 
    }

    .award-title { 
      font-weight: 700; 
      font-size: 14px; 
      color: var(--gray-800);
    }

    .award-text { 
      font-size: 13px; 
      color: var(--gray-600); 
    }

    /* Responsive design */
    @media (max-width: 1200px) {
      .grid {
        grid-template-columns: 1fr 2fr 1fr;
        gap: 20px;
      }
    }

    @media (max-width: 900px) {
      .grid {
        grid-template-columns: 1fr;
        grid-template-rows: auto auto auto auto auto;
        gap: 20px;
      }
      
      header {
        flex-direction: column;
        text-align: center;
        gap: 16px;
        padding: 20px 24px;
      }
      
      .nav {
        justify-content: center;
        flex-wrap: wrap;
        gap: 8px;
      }
      
      .btn {
        padding: 8px 14px;
        font-size: 13px;
      }
      
      .card {
        padding: 20px;
      }
      
      h1 {
        font-size: 24px;
      }
      
      h2 {
        font-size: 18px;
        margin-bottom: 12px;
      }
      
      .score-col {
        font-size: 28px;
        width: 100px;
      }
      
      .vs-col {
        width: 32px;
        font-size: 12px;
      }
      
      .name-col {
        font-size: 14px;
      }
      
      .standings th, .standings td {
        font-size: 13px;
        padding: 12px 8px;
      }
      
      .award {
        padding: 12px;
      }
      
      .award-icon {
        width: 28px;
        height: 28px;
        font-size: 14px;
      }
    }

    @media (max-width: 600px) {
      body {
        padding: 12px;
      }
      
      .grid {
        gap: 16px;
      }
      
      header {
        padding: 16px 20px;
        margin-bottom: 4px;
      }
      
      h1 {
        font-size: 20px;
        line-height: 1.2;
      }
      
      .nav {
        gap: 6px;
      }
      
      .btn {
        padding: 6px 12px;
        font-size: 12px;
        border-radius: 8px;
      }
      
      .card {
        padding: 16px;
        border-radius: 12px;
      }
      
      .score-col {
        font-size: 24px;
        width: 80px;
      }
      
      .vs-col {
        width: 28px;
        font-size: 11px;
      }
      
      .name-col {
        font-size: 13px;
      }
      
      th, td {
        padding: 12px 8px;
      }
      
      .standings th, .standings td {
        font-size: 12px;
        padding: 10px 6px;
      }
      
      .standings th:nth-child(2), .standings td:nth-child(2) {
        width: 70px;
      }
      
      .standings th:nth-child(3), .standings td:nth-child(3) {
        width: 60px;
      }
      
      .bb-table .pts-col {
        width: 60px;
        font-size: 18px;
      }
      
      .bb-logo {
        width: 20px;
        height: 20px;
      }
      
      .bb-name-text strong {
        font-size: 12px;
      }
      
      .bb-sub {
        font-size: 10px !important;
      }
      
      .award {
        padding: 12px;
        gap: 8px;
      }
      
      .award-icon {
        width: 24px;
        height: 24px;
        font-size: 12px;
      }
      
      .award-title {
        font-size: 13px;
      }
      
      .award-text {
        font-size: 12px;
      }
      
      .move {
        font-size: 11px;
        margin-left: 6px;
        padding: 1px 4px;
      }
    }

    @media (max-width: 480px) {
      body {
        padding: 8px;
      }
      
      .grid {
        gap: 12px;
      }
      
      header {
        padding: 12px 16px;
      }
      
      h1 {
        font-size: 18px;
      }
      
      .card {
        padding: 12px;
        border-radius: 8px;
      }
      
      .score-col {
        font-size: 20px;
        width: 60px;
      }
      
      .vs-col {
        width: 24px;
        font-size: 10px;
      }
      
      .name-col {
        font-size: 12px;
      }
      
      th, td {
        padding: 8px 6px;
      }
      
      .standings th, .standings td {
        font-size: 11px;
        padding: 8px 4px;
      }
      
      .bb-table .pts-col {
        width: 50px;
        font-size: 16px;
      }
      
      .award {
        padding: 8px;
      }
      
      .award-icon {
        width: 20px;
        height: 20px;
        font-size: 10px;
      }
      
      /* Ensure tables don't overflow on very small screens */
      .scores, .standings, .bb-table {
        font-size: 11px;
      }
      
      .scores td, .standings td, .bb-table td {
        word-break: break-word;
      }
      
      /* Stack navigation buttons vertically on very small screens */
      .nav {
        flex-direction: column;
        align-items: center;
      }
      
      .btn {
        width: 100%;
        justify-content: center;
        margin-bottom: 4px;
      }
    }
    
    /* Additional mobile optimizations */
    @media (max-width: 600px) {
      /* Ensure content doesn't get cut off */
      .grid {
        min-height: auto;
      }
      
      /* Make tables more readable on mobile */
      .scores tbody tr {
        border-bottom: 1px solid var(--gray-200);
      }
      
      .scores tbody tr:last-child {
        border-bottom: none;
      }
      
      /* Improve spacing for mobile */
      .section-divider {
        margin: 12px 0 16px;
      }
      
      /* Better mobile table layout */
      .bb-table th, .bb-table td {
        padding: 8px 4px;
      }
      
      /* Ensure tables don't cause horizontal scroll */
      .scores, .standings, .bb-table {
        max-width: 100%;
        overflow-x: auto;
      }
      
      /* Optimize table cell widths for mobile */
      .scores td {
        min-width: 0;
        max-width: none;
      }
      
      /* Better mobile grid layout */
      .grid {
        grid-template-rows: auto auto auto auto auto auto;
      }
    }
    
    /* Ensure proper mobile rendering */
    @media (max-width: 480px) {
      /* Prevent horizontal overflow */
      body {
        overflow-x: hidden;
      }
      
      .grid {
        width: 100%;
        max-width: 100%;
      }
      
      /* Stack all content vertically on very small screens */
      .card {
        margin-bottom: 16px;
      }
      
      /* Optimize table display for very small screens */
      .scores, .standings, .bb-table {
        font-size: 10px;
      }
      
      .scores td, .standings td, .bb-table td {
        padding: 6px 4px;
      }
      
      /* Ensure all content fits within viewport */
      .card {
        max-width: 100%;
        box-sizing: border-box;
      }
      
      /* Optimize text wrapping for very small screens */
      .name-col, .standings td:first-child {
        word-wrap: break-word;
        hyphens: auto;
      }
      
      /* Ensure navigation is mobile-friendly */
      .nav {
        width: 100%;
      }
      
      .btn {
        width: 100%;
        max-width: 200px;
        box-sizing: border-box;
      }
    }
  </style>
</head>
<body>
  <div class="grid">
    <header>
      <div>
        <h1>{{ league_name }} – Week {{ week }} Roundup</h1>
      </div>
      <div class="nav">
        <a class="btn" href="{% url 'homepage' %}">🏠 Home</a>
        {% if prev_disabled %}
          <span class="btn disabled">◀ Previous</span>
        {% else %}
          <a class="btn" href="{% url 'weekly_report' year=year week=prev_week %}">◀ Previous</a>
        {% endif %}
        {% if next_disabled %}
          <span class="btn disabled">Next ▶</span>
        {% else %}
          <a class="btn" href="{% url 'weekly_report' year=year week=next_week %}">Next ▶</a>
        {% endif %}
      </div>
    </header>

    <section class="card" style="grid-column: 1 / -1; grid-row: 2;">
      <h2>Overview</h2>
      <p id="overview">
        <span class="spinner" id="overview-spinner"></span>
        <span class="loading">Loading AI overview…</span>
      </p>
    </section>

    <!-- Center: Weekly Scores (fills remaining height) -->
    <section class="card" id="scores-card" style="grid-column: 2; grid-row: 3; display: flex; flex-direction: column;">
      <h2 style="text-align:center;">Weekly Scores</h2>
      <table class="scores" id="scores-table">
        <tbody>
          {% for m in scoreboard %}
          <tr>
            <td class="name-col">
              <div class="team-cell-home">
                <span>{{ m.home_team }}{% if m.home_record %} <span class="muted">({{ m.home_record }})</span>{% endif %}</span>
              </div>
            </td>
            <td class="score-col">
              {% if m.winner == m.home_team %}
                <strong>{{ m.home_score }}</strong>
              {% else %}
                <span>{{ m.home_score }}</span>
              {% endif %}
            </td>
            <td class="vs-col">vs</td>
            <td class="score-col">
              {% if m.winner == m.away_team %}
                <strong>{{ m.away_score }}</strong>
              {% else %}
                <span>{{ m.away_score }}</span>
              {% endif %}
            </td>
            <td class="name-col">
              <div class="team-cell-away">
                <span>{{ m.away_team }}{% if m.away_record %} <span class="muted">({{ m.away_record }})</span>{% endif %}</span>
              </div>
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </section>

    <!-- Left: Booms/Busts (full-height) -->
    <aside class="card" style="grid-column: 1; grid-row: 3;">
      <h2>Top Booms &amp; Busts by Position</h2>
      <div class="table-scroll">
          <table class="table-sticky bb-table">
          <thead>
            <tr>
                <th style="text-align:left; padding:6px 4px;">Pos</th>
                <th style="text-align:left; padding:6px 4px;">Boom</th>
                <th class="pts-col" style="padding:6px 4px;">Pts</th>
                <th class="pts-col" style="padding:6px 4px;">Pts</th>
                <th style="text-align:left; padding:6px 4px;">Bust</th>
            </tr>
          </thead>
          <tbody>
            {% for row in incentives.boom_bust_by_position %}
            <tr>
                <td style="padding:6px 4px; font-weight:bold;">{{ row.position }}</td>
                <td style="padding:6px 4px;" class="bb-name">
                  {% if row.boom %}
                    <div style="display:flex; align-items:center; gap:8px;">
                      <div>
                        <div class="bb-name-text"><strong>{{ row.boom.player_name }}</strong></div>
                        <div class="muted bb-sub">{{ row.boom.fantasy_team }}</div>
                      </div>
                      {% if row.boom.nfl_logo %}<img class="bb-logo" src="{{ row.boom.nfl_logo }}" alt="{{ row.boom.nfl_team }} logo" />{% endif %}
                    </div>
                  {% else %}
                    <span class="muted">—</span>
                  {% endif %}
                </td>
                <td class="pts-col" style="padding:6px 4px; font-weight:bold;">{% if row.boom %}{{ row.boom.points }}{% else %}—{% endif %}</td>
                <td class="pts-col" style="padding:6px 4px; font-weight:bold;">{% if row.bust %}{{ row.bust.points }}{% else %}—{% endif %}</td>
                <td style="padding:6px 4px;" class="bb-name">
                  {% if row.bust %}
                    <div style="display:flex; align-items:center; gap:8px;">
                      {% if row.bust.nfl_logo %}<img class="bb-logo" src="{{ row.bust.nfl_logo }}" alt="{{ row.bust.nfl_team }} logo" />{% endif %}
                      <div>
                        <div class="bb-name-text"><strong>{{ row.bust.player_name }}</strong></div>
                        <div class="muted bb-sub">{{ row.bust.fantasy_team }}</div>
                      </div>
                    </div>
                  {% else %}
                    <span class="muted">—</span>
                  {% endif %}
                </td>
            </tr>
            {% empty %}
            <tr><td colspan="3" class="muted" style="padding:6px 4px;">No player data available.</td></tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
      <div class="section-divider"></div>
      <div>
        <h2>Awards of the Week</h2>
        <ul class="awards">
          {% for a in awards %}
            <li class="award">
              <span class="award-icon">🏆</span>
              <div class="award-body">
                <div class="award-title">{{ a.title }}</div>
                <div class="award-text">{{ a.text }}</div>
              </div>
            </li>
          {% empty %}
            <li class="muted" style="padding: 6px 0;">No awards available.</li>
          {% endfor %}
        </ul>
      </div>
    </aside>

    <!-- Right: Standings and Weekly Incentive -->
    <aside class="card" style="grid-column: 3; grid-row: 3; display:flex; flex-direction:column; gap:12px;">
      <h2>Standings</h2>
      <table class="standings">
        <thead>
          <tr><th>Team</th><th>W-L-T</th><th>PF</th></tr>
        </thead>
        <tbody>
          {% for t in standings %}
          <tr class="{% if t.rank <= playoff_team_count %}playoff {% endif %}{% if t.rank == playoff_team_count %}cutoff{% endif %}">
            <td>
              <span>{{ t.team_name }}</span>
              {% if t.movement_abs %}
                {% if t.movement_is_up %}
                  <span class="move up">▲ {{ t.movement_abs }}</span>
                {% else %}
                  <span class="move down">▼ {{ t.movement_abs }}</span>
                {% endif %}
              {% endif %}
            </td>
            <td>{{ t.wins }}-{{ t.losses }}-{{ t.ties }}</td>
            <td>{{ t.points_for }}</td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
      <div class="muted" style="margin-top:6px;">Top {{ playoff_team_count }} highlighted as current playoff positions.</div>
      <div class="section-divider"></div>
      <div>
        <h2>Weekly Incentive</h2>
        <div style="margin-bottom:10px;">
          <div class="muted">This week's incentive</div>
          <div><strong>{{ weekly_incentive.this_title }}</strong></div>
        </div>
        <div style="margin-bottom:10px;">
          <div class="muted">Winner</div>
          <div><strong>{% if weekly_incentive.winner_text %}{{ weekly_incentive.winner_text }}{% else %}<span class="muted">TBD</span>{% endif %}</strong></div>
        </div>
        <div>
          <div class="muted">Next week's incentive</div>
          <div><strong>{{ weekly_incentive.next_title }}</strong></div>
        </div>
      </div>
    </aside>
    
  </div>
  <script>
    (function() {
      const overviewEndpoint = "{% url 'weekly_report_overview_api' year=year week=week %}";
      function setText(id, text) {
        const el = document.getElementById(id);
        if (el) { el.textContent = text || ''; }
      }
      function hideSpinner(id) {
        const spinner = document.getElementById(id);
        if (spinner) { spinner.classList.add('hidden'); }
      }
      function showError(id, spinnerId, msg) {
        hideSpinner(spinnerId);
        const el = document.getElementById(id);
        if (el) { el.innerHTML = `<span class="loading">${msg}</span>`; }
      }
      // Fetch smaller chunks in parallel
      function poll(endpoint, onOk, onError) {
        fetch(endpoint)
          .then(r => {
            if (r.status === 202) throw new Error('pending');
            if (!r.ok) throw new Error('error');
            return r.json();
          })
          .then(onOk)
          .catch(() => {
            onError();
            setTimeout(() => poll(endpoint, onOk, onError), 4000);
          });
      }

      poll(overviewEndpoint, (d) => {
        setText('overview', d.overview || '');
        hideSpinner('overview-spinner');
      }, () => {
        showError('overview', 'overview-spinner', 'Overview is taking longer than usual…');
      });

      function sizeWeeklyScores() {
        const card = document.getElementById('scores-card');
        const table = document.getElementById('scores-table');
        if (!card || !table) return;
        // Compute available height beneath the header inside the card
        const cardRect = card.getBoundingClientRect();
        const tableRect = table.getBoundingClientRect();
        const available = Math.max(0, cardRect.height - (tableRect.top - cardRect.top) - 8);
        table.style.height = available + 'px';

        const rows = table.querySelectorAll('tbody > tr');
        if (rows.length > 0) {
          const per = Math.max(48, Math.floor(available / rows.length));
          rows.forEach(r => { r.style.height = per + 'px'; });
        }
      }
      window.addEventListener('resize', sizeWeeklyScores);
      // Defer to next frame so layout is stable
      requestAnimationFrame(sizeWeeklyScores);

      // Simple tabs in left aside
      const tabButtons = document.querySelectorAll('.tab-btn');
      tabButtons.forEach(btn => {
        btn.addEventListener('click', () => {
          const tab = btn.getAttribute('data-tab');
          document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
          btn.classList.add('active');
          document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
          const target = document.getElementById(`tab-${tab}`);
          if (target) target.classList.add('active');
        });
      });
    })();
  </script>
</body>
</html>
