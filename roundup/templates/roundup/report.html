{% load report_extras %}
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>{{ league_name }} – Week {{ week }} Roundup</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 0; padding: 16px; color: #111; }
    .grid { display: grid; grid-template-columns: 1fr 2.5fr 1fr; grid-template-rows: auto auto 1fr; gap: 16px; min-height: 100vh; }
    header { grid-column: 1 / -1; display: flex; align-items: center; justify-content: space-between; gap: 12px; flex-wrap: wrap; }
    .card { background: #fafafa; border: 1px solid #e5e5e5; border-radius: 8px; padding: 12px 14px; }
    h1 { margin: 0; font-size: 22px; }
    h2 { margin: 0 0 8px; font-size: 18px; }
    ul { margin: 8px 0; padding-left: 18px; }
    table { width: 100%; border-collapse: collapse; }
    .scores { width: 100%; table-layout: fixed; }
    th, td { padding: 6px 8px; border-bottom: 1px solid #eee; vertical-align: middle; }
    th { text-align: left; }
    .standings tr.playoff { background: #eaf7ea; }
    .standings tr.cutoff > td { border-bottom: 2px solid #b7dfb7; }
    .muted { color: #666; font-size: 13px; }
    .two-col { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
    .scores { font-variant-numeric: tabular-nums; }
    .team-cell { display: flex; align-items: center; gap: 8px; }
    .team-cell img { width: 22px; height: 22px; border-radius: 4px; object-fit: cover; background: #fff; border: 1px solid #ddd; }
    .score-col { width: 120px; text-align: center; font-size: 28px; }
    .vs-col { width: 40px; text-align: center; color: #999; }
    .logo-col { width: 28px; text-align: center; }
    .logo-img { width: 22px; height: 22px; border-radius: 4px; object-fit: cover; background: #fff; border: 1px solid #ddd; }
    .name-col { width: auto; }
    .move { font-size: 12px; margin-left: 6px; }
    .move.up { color: #138a36; }
    .move.down { color: #c92a2a; }
    .nav { display: flex; align-items: center; gap: 8px; }
    .btn { display: inline-flex; align-items: center; gap: 6px; padding: 6px 10px; border: 1px solid #ddd; border-radius: 6px; background: #fff; color: #111; text-decoration: none; font-size: 14px; }
    .btn:hover { background: #f5f5f5; }
    .btn.disabled { pointer-events: none; opacity: 0.5; }
    .loading { color: #666; font-style: italic; }
    .hidden { display: none; }
    .spinner { width: 16px; height: 16px; border: 2px solid #ddd; border-top-color: #333; border-radius: 50%; display: inline-block; animation: spin 0.9s linear infinite; vertical-align: text-bottom; margin-right: 6px; }
    @keyframes spin { from { transform: rotate(0deg);} to { transform: rotate(360deg);} }
    .table-sticky thead th { position: sticky; top: 0; background: #fafafa; z-index: 1; }
    .pts-col { width: 64px; text-align: center; font-variant-numeric: tabular-nums; font-size: 20px; }
    /* Booms/Busts table refinements */
    .bb-table { width: 100%; border-collapse: collapse; }
    .bb-table th + th, .bb-table td + td { border-left: 1px solid #e5e5e5; }
    .bb-table .logo-col { width: 36px; text-align: center; }
    .bb-table .pts-col { width: 80px; font-size: 22px; }
    .bb-logo { width: 24px; height: 24px; }
    .bb-name-text strong { font-size: 13px; font-weight: 700; }
    .bb-sub { font-size: 11px !important; }
    .section-divider { border-top: 2px solid #e0e0e0; margin: 10px 0 12px; }
  </style>
</head>
<body>
  <div class="grid">
    <header>
      <div>
        <h1>{{ league_name }} – Week {{ week }} Roundup</h1>
        <div class="muted">Consistent layout: scores (top-right), incentives (bottom-left)</div>
      </div>
      <div class="nav">
        {% if prev_disabled %}
          <span class="btn disabled">◀ Previous</span>
        {% else %}
          <a class="btn" href="{% url 'weekly_report' year=year week=prev_week %}">◀ Previous</a>
        {% endif %}
        {% if next_disabled %}
          <span class="btn disabled">Next ▶</span>
        {% else %}
          <a class="btn" href="{% url 'weekly_report' year=year week=next_week %}">Next ▶</a>
        {% endif %}
      </div>
    </header>

    <section class="card" style="grid-column: 1 / -1; grid-row: 2;">
      <h2>Overview</h2>
      <p id="overview">
        <span class="spinner" id="overview-spinner"></span>
        <span class="loading">Loading AI overview…</span>
      </p>
    </section>

    <!-- Center: Weekly Scores (fills remaining height) -->
    <section class="card" id="scores-card" style="grid-column: 2; grid-row: 3; display: flex; flex-direction: column;">
      <h2 style="text-align:center;">Weekly Scores</h2>
      <table class="scores" id="scores-table">
        <tbody>
          {% for m in scoreboard %}
          <tr>
            <td class="name-col">
              <div class="team-cell">
                <span>{{ m.home_team }}{% if m.home_record %} <span class="muted">({{ m.home_record }})</span>{% endif %}</span>
              </div>
            </td>
            <td class="logo-col">
              {% if m.home_logo %}<img class="logo-img" src="{{ m.home_logo }}" alt="{{ m.home_team }} logo" />{% endif %}
            </td>
            <td class="score-col">
              {% if m.winner == m.home_team %}
                <strong>{{ m.home_score }}</strong>
              {% else %}
                <span>{{ m.home_score }}</span>
              {% endif %}
            </td>
            <td class="vs-col">vs</td>
            <td class="score-col">
              {% if m.winner == m.away_team %}
                <strong>{{ m.away_score }}</strong>
              {% else %}
                <span>{{ m.away_score }}</span>
              {% endif %}
            </td>
            <td class="logo-col">
              {% if m.away_logo %}<img class="logo-img" src="{{ m.away_logo }}" alt="{{ m.away_team }} logo" />{% endif %}
            </td>
            <td class="name-col">
              <div class="team-cell">
                <span>{{ m.away_team }}{% if m.away_record %} <span class="muted">({{ m.away_record }})</span>{% endif %}</span>
              </div>
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </section>

    <!-- Left: Booms/Busts (full-height) -->
    <aside class="card" style="grid-column: 1; grid-row: 3;">
      <h2>Booms &amp; Busts by Position</h2>
      <div class="table-scroll">
          <table class="table-sticky bb-table">
          <thead>
            <tr>
                <th style="text-align:left; padding:6px 4px;">Pos</th>
                <th style="text-align:left; padding:6px 4px;">Boom</th>
                <th class="pts-col" style="padding:6px 4px;">Pts</th>
                <th class="pts-col" style="padding:6px 4px;">Pts</th>
                <th style="text-align:left; padding:6px 4px;">Bust</th>
            </tr>
          </thead>
          <tbody>
            {% for row in incentives.boom_bust_by_position %}
            <tr>
                <td style="padding:6px 4px; font-weight:bold;">{{ row.position }}</td>
                <td style="padding:6px 4px;" class="bb-name">
                  {% if row.boom %}
                    <div style="display:flex; align-items:center; gap:8px;">
                      <div>
                        <div class="bb-name-text"><strong>{{ row.boom.player_name }}</strong></div>
                        <div class="muted bb-sub">{{ row.boom.nfl_team }} for {{ row.boom.fantasy_team }}</div>
                      </div>
                      {% if row.boom.nfl_logo %}<img class="bb-logo" src="{{ row.boom.nfl_logo }}" alt="{{ row.boom.nfl_team }} logo" />{% endif %}
                    </div>
                  {% else %}
                    <span class="muted">—</span>
                  {% endif %}
                </td>
                <td class="pts-col" style="padding:6px 4px; font-weight:bold;">{% if row.boom %}{{ row.boom.points }}{% else %}—{% endif %}</td>
                <td class="pts-col" style="padding:6px 4px; font-weight:bold;">{% if row.bust %}{{ row.bust.points }}{% else %}—{% endif %}</td>
                <td style="padding:6px 4px;" class="bb-name">
                  {% if row.bust %}
                    <div style="display:flex; align-items:center; gap:8px;">
                      {% if row.bust.nfl_logo %}<img class="bb-logo" src="{{ row.bust.nfl_logo }}" alt="{{ row.bust.nfl_team }} logo" />{% endif %}
                      <div>
                        <div class="bb-name-text"><strong>{{ row.bust.player_name }}</strong></div>
                        <div class="muted bb-sub">{{ row.bust.nfl_team }} for {{ row.bust.fantasy_team }}</div>
                      </div>
                    </div>
                  {% else %}
                    <span class="muted">—</span>
                  {% endif %}
                </td>
            </tr>
            {% empty %}
            <tr><td colspan="3" class="muted" style="padding:6px 4px;">No player data available.</td></tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
      <div class="section-divider"></div>
      <div>
        <h2>Awards of the Week</h2>
        <ul>
          {% for a in awards %}
            <li><strong>{{ a.title }}:</strong> {{ a.text }}</li>
          {% empty %}
            <li class="muted">No awards available.</li>
          {% endfor %}
        </ul>
      </div>
    </aside>

    <!-- Right: Standings and Weekly Incentive -->
    <aside class="card" style="grid-column: 3; grid-row: 3; display:flex; flex-direction:column; gap:12px;">
      <h2>Standings</h2>
      <table class="standings">
        <thead>
          <tr><th>Team</th><th>W-L-T</th><th>PF</th></tr>
        </thead>
        <tbody>
          {% for t in standings %}
          <tr class="{% if t.rank <= playoff_team_count %}playoff {% endif %}{% if t.rank == playoff_team_count %}cutoff{% endif %}">
            <td>
              <span>{{ t.team_name }}</span>
              {% if t.movement_abs %}
                {% if t.movement_is_up %}
                  <span class="move up">▲ {{ t.movement_abs }}</span>
                {% else %}
                  <span class="move down">▼ {{ t.movement_abs }}</span>
                {% endif %}
              {% endif %}
            </td>
            <td>{{ t.wins }}-{{ t.losses }}-{{ t.ties }}</td>
            <td>{{ t.points_for }}</td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
      <div class="muted" style="margin-top:6px;">Top {{ playoff_team_count }} highlighted as current playoff positions.</div>
      <div class="section-divider"></div>
      <div>
        <h2>Weekly Incentive</h2>
        <div style="margin-bottom:10px;">
          <div class="muted">This week's incentive</div>
          <div><strong>{{ weekly_incentive.this_title }}</strong></div>
        </div>
        <div style="margin-bottom:10px;">
          <div class="muted">Winner</div>
          <div>{% if weekly_incentive.winner_text %}{{ weekly_incentive.winner_text }}{% else %}<span class="muted">TBD</span>{% endif %}</div>
        </div>
        <div>
          <div class="muted">Next week's incentive</div>
          <div>{{ weekly_incentive.next_title }}</div>
        </div>
      </div>
    </aside>
    
  </div>
  <script>
    (function() {
      const overviewEndpoint = "{% url 'weekly_report_overview_api' year=year week=week %}";
      function setText(id, text) {
        const el = document.getElementById(id);
        if (el) { el.textContent = text || ''; }
      }
      function hideSpinner(id) {
        const spinner = document.getElementById(id);
        if (spinner) { spinner.classList.add('hidden'); }
      }
      function showError(id, spinnerId, msg) {
        hideSpinner(spinnerId);
        const el = document.getElementById(id);
        if (el) { el.innerHTML = `<span class="loading">${msg}</span>`; }
      }
      // Fetch smaller chunks in parallel
      function poll(endpoint, onOk, onError) {
        fetch(endpoint)
          .then(r => {
            if (r.status === 202) throw new Error('pending');
            if (!r.ok) throw new Error('error');
            return r.json();
          })
          .then(onOk)
          .catch(() => {
            onError();
            setTimeout(() => poll(endpoint, onOk, onError), 4000);
          });
      }

      poll(overviewEndpoint, (d) => {
        setText('overview', d.overview || '');
        hideSpinner('overview-spinner');
      }, () => {
        showError('overview', 'overview-spinner', 'Overview is taking longer than usual…');
      });

      function sizeWeeklyScores() {
        const card = document.getElementById('scores-card');
        const table = document.getElementById('scores-table');
        if (!card || !table) return;
        // Compute available height beneath the header inside the card
        const cardRect = card.getBoundingClientRect();
        const tableRect = table.getBoundingClientRect();
        const available = Math.max(0, cardRect.height - (tableRect.top - cardRect.top) - 8);
        table.style.height = available + 'px';

        const rows = table.querySelectorAll('tbody > tr');
        if (rows.length > 0) {
          const per = Math.max(48, Math.floor(available / rows.length));
          rows.forEach(r => { r.style.height = per + 'px'; });
        }
      }
      window.addEventListener('resize', sizeWeeklyScores);
      // Defer to next frame so layout is stable
      requestAnimationFrame(sizeWeeklyScores);

      // Simple tabs in left aside
      const tabButtons = document.querySelectorAll('.tab-btn');
      tabButtons.forEach(btn => {
        btn.addEventListener('click', () => {
          const tab = btn.getAttribute('data-tab');
          document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
          btn.classList.add('active');
          document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
          const target = document.getElementById(`tab-${tab}`);
          if (target) target.classList.add('active');
        });
      });
    })();
  </script>
</body>
</html>
