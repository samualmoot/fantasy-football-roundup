{% load report_extras %}
{% load dict_extras %}
<!DOCTYPE html>
<html lang="en">
<head>
  {% load static %}
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>{{ league_name }} ‚Äì Week {{ week }} Roundup</title>
  <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üèà</text></svg>">
  <link rel="stylesheet" href="{% static 'roundup/report.css' %}">
</head>
<body>
  <div class="grid">
    <header>
      <div>
        <h1>{{ league_name }} ‚Äì Week {{ week }} Roundup</h1>
      </div>
      <div class="nav">
        <a class="btn" href="{% url 'homepage' %}">üè† Home</a>
        {% if prev_disabled %}
          <span class="btn disabled">‚óÄ Previous</span>
        {% else %}
          <a class="btn" href="{% url 'weekly_report' year=year week=prev_week %}">‚óÄ Previous</a>
        {% endif %}
        {% if next_disabled %}
          <span class="btn disabled">Next ‚ñ∂</span>
        {% else %}
          <a class="btn" href="{% url 'weekly_report' year=year week=next_week %}">Next ‚ñ∂</a>
        {% endif %}
      </div>
    </header>

    <section class="card overview-card overview-section">
      <h2>Overview</h2>
      <p id="overview">
        <span class="spinner" id="overview-spinner"></span>
        <span class="loading">Loading AI overview‚Ä¶</span>
      </p>
    </section>

    <!-- Left: Standings (stretches from below overview to bottom) -->
    <aside class="card standings-card standings-aside">
      <h2>Standings</h2>
      
      <!-- Desktop Standings - Card Layout -->
      <div class="desktop-standings" id="standings-container">
        <!-- Loading state -->
        <div class="loading-state" id="standings-loading">
          <div class="loading-spinner"></div>
          <div class="loading-text">Loading standings...</div>
        </div>
        <!-- Content will be loaded here -->
        <div id="standings-content" style="display: none;"></div>
      </div>
      
      <div class="muted-with-margin">Top {{ playoff_team_count }} highlighted as current playoff positions.</div>
    </aside>



    <!-- Right: Player Highlights and Weekly Incentive (top row) -->
    <div class="overview-row">
      <section class="card highlights-card">
        <h2>‚≠ê Player Highlights</h2>
        <div id="awards-container">
          <!-- Loading state -->
          <div class="loading-state" id="awards-loading">
            <div class="loading-spinner"></div>
            <div class="loading-text">Loading awards...</div>
          </div>
          <!-- Content will be loaded here -->
          <div id="awards-content" style="display: none;"></div>
        </div>
      </section>
  
      <section class="card incentive-card">
        <h2>üèÜ Weekly Incentive</h2>
        <div id="incentive-container">
          <!-- Loading state -->
          <div class="loading-state" id="incentive-loading">
            <div class="loading-spinner"></div>
            <div class="loading-text">Loading incentive...</div>
          </div>
          <!-- Content will be loaded here -->
          <div id="incentive-content" style="display: none;"></div>
        </div>
      </section>
    </div>

    <!-- Right: Weekly Scores (middle row) -->
    <section class="card scores-card scores-section" id="scores-card">
      <h2>Weekly Scores</h2>
      
      <!-- Desktop Scores - Card Layout (Horizontal Flow) -->
      <div class="desktop-scores" id="scores-container">
        <!-- Loading state -->
        <div class="loading-state" id="scores-loading">
          <div class="loading-spinner"></div>
          <div class="loading-text">Loading scores...</div>
        </div>
        <!-- Content will be loaded here -->
        <div id="scores-content" style="display: none;"></div>
      </div>
      
      <!-- Mobile Scores - Simplified Layout -->
      <div class="mobile-scores" id="mobile-scores-container">
        <!-- Loading state -->
        <div class="loading-state" id="mobile-scores-loading">
          <div class="loading-spinner"></div>
          <div class="loading-text">Loading scores...</div>
        </div>
        <!-- Content will be loaded here -->
        <div id="mobile-scores-content" style="display: none;"></div>
      </div>
    </section>

    <!-- Mobile Standings Layout - Positioned below weekly scores -->
    <div class="mobile-standings" id="mobile-standings-container">
      <!-- Loading state -->
      <div class="loading-state" id="mobile-standings-loading">
        <div class="loading-spinner"></div>
        <div class="loading-text">Loading standings...</div>
              </div>
      <!-- Content will be loaded here -->
      <div id="mobile-standings-content" style="display: none;"></div>
              </div>

    <!-- Right: Booms & Busts (bottom row) -->
    <section class="card bb-card bb-section-below">
      <h2>Booms &amp; Busts</h2>
      <div class="bb-positions-grid" id="booms-busts-container">
        <!-- Loading state -->
        <div class="loading-state" id="booms-busts-loading">
          <div class="loading-spinner"></div>
          <div class="loading-text">Loading player data...</div>
        </div>
        <!-- Content will be loaded here -->
        <div id="booms-busts-content" style="display: none;"></div>
      </div>
    </section>
  </div>

  <!-- Mobile Booms/Busts Layout - Positioned at bottom of page -->
  <div class="mobile-bb-bottom" id="mobile-booms-busts-container">
    <!-- Loading state -->
    <div class="loading-state" id="mobile-booms-busts-loading">
      <div class="loading-spinner"></div>
      <div class="loading-text">Loading player data...</div>
    </div>
    <!-- Content will be loaded here -->
    <div id="mobile-booms-busts-content" style="display: none;"></div>
    
  </div>

  <script>
    // Function to load overview content
    async function loadOverview() {
      try {
        const overviewElement = document.getElementById('overview');
        const overviewSpinner = document.getElementById('overview-spinner');
        
        if (!overviewElement || !overviewSpinner) {
          console.error('Overview elements not found');
          return;
        }
        
        const response = await fetch(`{% url 'weekly_report_overview_api' year=year week=week %}`);
        if (!response.ok) {
          throw new Error(`HTTP error! status: ${response.status}`);
        }
        const data = await response.json();
        
        if (data.overview) {
          overviewElement.innerHTML = data.overview;
        } else {
          overviewElement.innerHTML = '<span class="error">No overview available.</span>';
        }
      } catch (error) {
        console.error('Error loading overview:', error);
        const overviewElement = document.getElementById('overview');
        if (overviewElement) {
          overviewElement.innerHTML = '<span class="error">Failed to load overview. Please try again later.</span>';
        }
      } finally {
        const overviewSpinner = document.getElementById('overview-spinner');
        if (overviewSpinner) {
          overviewSpinner.style.display = 'none';
        }
      }
    }
    
    // Progressive component loading
    async function loadAllComponents() {
      console.log('loadAllComponents called');
      const year = {{ year }};
      const week = {{ week }};
      console.log(`Loading components for year ${year}, week ${week}`);
      
      // Load all components in parallel
      await Promise.all([
        loadStandings(year, week),
        loadScores(year, week),
        loadBoomsBusts(year, week),
        loadAwards(year, week),
        loadIncentive(year, week)
      ]);
      console.log('All components loaded');
    }
    
    // Load standings data
    async function loadStandings(year, week) {
      console.log('Loading standings...');
      try {
        const response = await fetch(`/report/${year}/${week}/standings.json`);
        const data = await response.json();
        
        if (data.standings) {
          // Hide loading state
          document.getElementById('standings-loading').style.display = 'none';
          document.getElementById('mobile-standings-loading').style.display = 'none';
          
          // Render desktop standings
          renderStandings(data.standings, 'standings-content', false);
          // Render mobile standings
          renderStandings(data.standings, 'mobile-standings-content', true);
          
          // Show content
          document.getElementById('standings-content').style.display = 'block';
          document.getElementById('mobile-standings-content').style.display = 'block';
        }
      } catch (error) {
        console.error('Error loading standings:', error);
        showError('standings-loading', 'Failed to load standings');
      }
    }
    
    // Load scores data
    async function loadScores(year, week) {
      console.log('Loading scores...');
      try {
        const response = await fetch(`/report/${year}/${week}/scoreboard.json`);
        const data = await response.json();
        
        if (data.scoreboard) {
          // Hide loading state
          document.getElementById('scores-loading').style.display = 'none';
          document.getElementById('mobile-scores-loading').style.display = 'none';
          
          // Render desktop scores
          renderScores(data.scoreboard, data.team_logos, 'scores-content', false);
          // Render mobile scores
          renderScores(data.scoreboard, data.team_logos, 'mobile-scores-content', true);
          
          // Show content
          document.getElementById('scores-content').style.display = 'block';
          document.getElementById('mobile-scores-content').style.display = 'block';
        }
      } catch (error) {
        console.error('Error loading scores:', error);
        showError('scores-loading', 'Failed to load scores');
      }
    }
    
    // Load booms and busts data
    async function loadBoomsBusts(year, week) {
      try {
        const response = await fetch(`/report/${year}/${week}/booms-busts.json`);
        const data = await response.json();
        
        if (data.incentives) {
          // Hide loading state
          document.getElementById('booms-busts-loading').style.display = 'none';
          document.getElementById('mobile-booms-busts-loading').style.display = 'none';
          
          // Render desktop booms and busts
          renderBoomsBusts(data.incentives, data.nfl_logos, 'booms-busts-container', false);
          // Render mobile booms and busts
          renderBoomsBusts(data.incentives, data.nfl_logos, 'mobile-booms-busts-content', true);
          
          // Show content
          document.getElementById('booms-busts-container').style.display = 'block';
          document.getElementById('mobile-booms-busts-content').style.display = 'block';
        }
      } catch (error) {
        console.error('Error loading booms and busts:', error);
        showError('booms-busts-loading', 'Failed to load player data');
      }
    }
    
    // Load awards data
    async function loadAwards(year, week) {
      try {
        const response = await fetch(`/report/${year}/${week}/awards.json`);
        const data = await response.json();
        
        if (data.awards) {
          // Hide loading state
          document.getElementById('awards-loading').style.display = 'none';
          
          // Render awards
          renderAwards(data.awards, 'awards-content');
          
          // Show content
          document.getElementById('awards-content').style.display = 'block';
        }
      } catch (error) {
        console.error('Error loading awards:', error);
        showError('awards-loading', 'Failed to load awards');
      }
    }
    
    // Load incentive data
    async function loadIncentive(year, week) {
      try {
        const response = await fetch(`/report/${year}/${week}/booms-busts.json`);
        const data = await response.json();
        
        if (data.incentives) {
          // Hide loading state
          document.getElementById('incentive-loading').style.display = 'none';
          
          // Render incentive
          renderIncentive(data.incentives, 'incentive-content');
          
          // Show content
          document.getElementById('incentive-content').style.display = 'block';
        }
      } catch (error) {
        console.error('Error loading incentive:', error);
        showError('incentive-loading', 'Failed to load incentive');
      }
    }
    
    // Render functions
    function renderStandings(standings, containerId, isMobile) {
      const container = document.getElementById(containerId);
      const playoffTeamCount = {{ playoff_team_count }};
      
      let html = '';
      standings.forEach(team => {
        const playoffClass = team.rank <= playoffTeamCount ? 'playoff' : '';
        const cutoffClass = team.rank === playoffTeamCount + 1 ? 'cutoff' : '';
        
        if (isMobile) {
          html += `
            <div class="mobile-standing-item ${playoffClass} ${cutoffClass}">
              <div class="mobile-standing-rank">#${team.rank}</div>
              <div class="mobile-standing-team">
                <div class="mobile-team-name">${team.team_name}</div>
                ${team.owner_name ? `<div class="mobile-team-owner">${team.owner_name}</div>` : ''}
                                 ${team.movement_abs ? `
                   <span class="move ${team.movement_is_up ? 'up' : 'down'}">
                     ${team.movement_is_up ? '‚ñ≤' : '‚ñº'} ${team.movement_abs}
                   </span>
                 ` : ''}
               </div>
               <div class="mobile-standing-stats">
                 <div class="mobile-standing-record">${team.wins}-${team.losses}-${team.ties}</div>
               </div>
             </div>
           `;
         } else {
           html += `
             <div class="standing-team-card ${playoffClass} ${cutoffClass}">
               <div class="standing-rank">
                 <div class="rank-number">#${team.rank}</div>
                 ${team.rank <= playoffTeamCount ? '<div class="playoff-badge">üèÜ</div>' : ''}
               </div>
               <div class="standing-team-info">
                 <div class="team-name">${team.team_name}</div>
                 ${team.owner_name ? `<div class="team-owner">${team.owner_name}</div>` : ''}
                 ${team.movement_abs ? `
                   <div class="movement-indicator ${team.movement_is_up ? 'up' : 'down'}">
                     ${team.movement_is_up ? '‚ñ≤' : '‚ñº'} ${team.movement_abs}
                   </div>
                 ` : ''}
               </div>
               <div class="standing-stats">
                 <div class="record-badge">${team.wins}-${team.losses}-${team.ties}</div>
               </div>
             </div>
           `;
         }
       });
       
       container.innerHTML = html;
     }
     
     function renderScores(scoreboard, teamLogos, containerId, isMobile) {
       const container = document.getElementById(containerId);
       
       let html = '';
       scoreboard.forEach(matchup => {
         if (isMobile) {
           html += `
             <div class="mobile-score-card">
               <div class="mobile-score-team">
                 ${matchup.home_logo ? `<img class="mobile-score-team-logo" src="${teamLogos[matchup.home_id] || '/assets/team-logo/' + matchup.home_id + '.png'}" alt="${matchup.home_team} logo" />` : ''}
                 <div class="mobile-score-team-details">
                   <div class="mobile-team-name">${matchup.home_team}</div>
                   ${matchup.home_owner ? `<div class="mobile-team-owner">${matchup.home_owner}</div>` : ''}
                   <div class="mobile-team-record">${matchup.home_wins}-${matchup.home_losses}-${matchup.home_ties}</div>
                 </div>
                 <div class="mobile-score-home">${(Number(matchup.home_score ?? 0)).toFixed(1)}</div>
               </div>
               <div class="mobile-score-vs">vs</div>
               <div class="mobile-score-team">
                 ${matchup.away_logo ? `<img class="mobile-score-team-logo" src="${teamLogos[matchup.away_id] || '/assets/team-logo/' + matchup.away_id + '.png'}" alt="${matchup.away_team} logo" />` : ''}
                 <div class="mobile-score-team-details">
                   <div class="mobile-team-name">${matchup.away_team}</div>
                   ${matchup.away_owner ? `<div class="mobile-team-owner">${matchup.away_owner}</div>` : ''}
                   <div class="mobile-team-record">${matchup.away_wins}-${matchup.away_losses}-${matchup.away_ties}</div>
                 </div>
                 <div class="mobile-score-away">${(Number(matchup.away_score ?? 0)).toFixed(1)}</div>
               </div>
             </div>
           `;
         } else {
           html += `
             <div class="score-matchup-card">
               <div class="score-team-left">
                 ${matchup.home_logo ? `<img class="score-team-logo" src="${teamLogos[matchup.home_id] || '/assets/team-logo/' + matchup.home_id + '.png'}" alt="${matchup.home_team} logo" />` : ''}
                 <div class="score-team-details">
                   <div class="team-name">${matchup.home_team}</div>
                   ${matchup.home_owner ? `<div class="team-owner">${matchup.home_owner}</div>` : ''}
                   <div class="team-record">${matchup.home_wins}-${matchup.home_losses}-${matchup.home_ties}</div>
                 </div>
               </div>
               <div class="score-scores-container">
                 <div class="score-home">${(Number(matchup.home_score ?? 0)).toFixed(1)}</div>
                 <div class="score-vs">vs</div>
                 <div class="score-away">${(Number(matchup.away_score ?? 0)).toFixed(1)}</div>
               </div>
               <div class="score-team-right">
                 <div class="score-team-details">
                   <div class="team-name">${matchup.away_team}</div>
                   ${matchup.away_owner ? `<div class="team-owner">${matchup.away_owner}</div>` : ''}
                   <div class="team-record">${matchup.away_wins}-${matchup.away_losses}-${matchup.away_ties}</div>
                 </div>
                 ${matchup.away_logo ? `<img class="score-team-logo" src="${teamLogos[matchup.away_id] || '/assets/team-logo/' + matchup.away_id + '.png'}" alt="${matchup.away_team} logo" />` : ''}
               </div>
             </div>
           `;
         }
       });
       
       container.innerHTML = html;
     }
     
     function renderBoomsBusts(incentives, nflLogos, containerId, isMobile) {
       const container = document.getElementById(containerId);
       const positions = ['QB', 'RB', 'WR', 'TE', 'K', 'DEF'];
       
       let html = '';
       positions.forEach(position => {
         const row = incentives.boom_bust_by_position.find(r => r.position === position);
         // Always generate a card for each position, even if empty
         const booms = row ? row.booms : [];
         const busts = row ? row.busts : [];
         
         if (isMobile) {
             html += `
               <div class="mobile-bb-position">
                 <div class="mobile-bb-position-title">${position}</div>
                 <div class="mobile-bb-sections-container">
                   <div class="mobile-bb-section">
                     <div class="mobile-bb-section-title">Top 3 Booms</div>
                     <div class="mobile-bb-players-list">
                       ${booms.map(player => `
                         <div class="mobile-bb-player-item boom">
                           <img class="mobile-bb-player-nfl-logo" src="${player.nfl_logo}" alt="${player.nfl_team} logo" />
                           <div class="mobile-bb-player-info">
                             <div class="mobile-bb-player-name">${player.player_name}</div>
                             <div class="mobile-bb-player-team">${player.fantasy_team}</div>
                           </div>
                           <div class="mobile-bb-player-points">${player.points} pts</div>
                         </div>
                       `).join('')}
                     </div>
                   </div>
                   <div class="mobile-bb-section">
                     <div class="mobile-bb-section-title">Top 3 Busts</div>
                     <div class="mobile-bb-players-list">
                       ${busts.map(player => `
                         <div class="mobile-bb-player-item bust">
                           <img class="mobile-bb-player-nfl-logo" src="${player.nfl_logo}" alt="${player.nfl_team} logo" />
                           <div class="mobile-bb-player-info">
                             <div class="mobile-bb-player-name">${player.player_name}</div>
                             <div class="mobile-bb-player-team">${player.fantasy_team}</div>
                           </div>
                           <div class="mobile-bb-player-points">${player.points} pts</div>
                         </div>
                       `).join('')}
                     </div>
                   </div>
                 </div>
               </div>
             `;
           } else {
             html += `
               <div class="bb-position-card">
                 <div class="bb-position-header">${position}</div>
                 <div class="bb-sections-container">
                   <div class="bb-section">
                     <div class="bb-section-header boom">
                       <span class="bb-section-title">Top 3 Booms</span>
                     </div>
                     <div class="bb-players-list">
                       ${booms.map(player => `
                         <div class="bb-player-item boom">
                           <img class="bb-player-nfl-logo" src="${player.nfl_logo}" alt="${player.nfl_team} logo" />
                           <div class="bb-player-info">
                             <div class="bb-player-name">${player.player_name}</div>
                             <div class="bb-player-team">${player.fantasy_team}</div>
                           </div>
                           <div class="bb-player-points">${player.points} pts</div>
                         </div>
                       `).join('')}
                     </div>
                   </div>
                   <div class="bb-section">
                     <div class="bb-section-header bust">
                       <span class="bb-section-title">Top 3 Busts</span>
                     </div>
                     <div class="bb-players-list">
                       ${busts.map(player => `
                         <div class="bb-player-item bust">
                           <img class="bb-player-nfl-logo" src="${player.nfl_logo}" alt="${player.nfl_team} logo" />
                           <div class="bb-player-name">${player.player_name}</div>
                           <div class="bb-player-team">${player.fantasy_team}</div>
                           <div class="bb-player-points">${player.points} pts</div>
                         </div>
                       `).join('')}
                     </div>
                   </div>
                 </div>
               </div>
             `;
           }
         
       });
       
       container.innerHTML = html;
      }
     
     function renderAwards(awards, containerId) {
       const container = document.getElementById(containerId);
       
       let html = '<ul class="awards">';
       awards.forEach(award => {
         html += `
           <li class="award">
             <span class="award-icon">‚≠ê</span>
             <div class="award-body">
               <div class="award-title">${award.title}</div>
               <div class="award-text">${award.text}</div>
             </div>
           </li>
         `;
       });
       html += '</ul>';
       
       container.innerHTML = html;
     }
     
     function renderIncentive(incentives, containerId) {
       const container = document.getElementById(containerId);
       
       // This would need to be enhanced to get the actual incentive data
       // For now, showing a placeholder
       const html = `
         <div class="incentive-content">
           <div class="incentive-section">
             <div class="incentive-label">This Week's Challenge</div>
             <div class="incentive-title">Weekly Challenge</div>
           </div>
           <div class="incentive-section">
             <div class="incentive-label">üèÖ Winner</div>
             <div class="incentive-winner">
               <span class="pending-text">TBD - Check back after the games!</span>
             </div>
           </div>
           <div class="incentive-section">
             <div class="incentive-label">üéØ Next Week's Challenge</div>
             <div class="incentive-next">Next Challenge</div>
           </div>
         </div>
       `;
       
       container.innerHTML = html;
     }
     
     function showError(loadingId, message) {
       const loadingElement = document.getElementById(loadingId);
       loadingElement.innerHTML = `
         <div style="color: var(--danger); text-align: center; padding: 1rem;">
           <div style="margin-bottom: 0.5rem;">‚ö†Ô∏è</div>
           <div>${message}</div>
         </div>
       `;
     }
     
     // Start loading all components after all functions are defined
     document.addEventListener('DOMContentLoaded', function() {
       console.log('DOM loaded, starting component loading...');
       loadOverview();
       loadAllComponents();
     });
   </script>
</body>
</html>
